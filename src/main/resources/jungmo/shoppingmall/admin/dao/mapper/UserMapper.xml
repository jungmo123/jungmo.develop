<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd"> 
<mapper namespace="jungmo.shoppingmall.admin.user.dao.mapper.UserMapper">
	<select id = "getUsers" parameterType = "page" resultMap = "userMap">
		  <![CDATA[
		  select * from(
		  	select rownum as rnum, x.* from(	
				select user_joindate,user_name,user_level,user_id,sum(totalprice) as purchase_amount,user_hp,visitcnt,user_mailagreement from(
				select user_joindate,user_name,user_id,ord_num,
				(case when sum(price)-usingpoint <  freedeliverymp then sum(price)-usingpoint+basic_fee
				else sum(price)-usingpoint
				end) as totalprice
				,user_hp,visitcnt,user_mailagreement,user_level from(
				select b.user_joindate,b.user_name,b.user_id,b.ord_num,b.god_num,b.god_amount*(b.god_sellingprice+nvl(a.price,'0')) as price,b.user_hp,visitcnt,user_mailagreement,b.usingpoint,freedeliverymp,basic_fee,b.user_level from(
				(select user_id,ord_num,god_num,sum(opt_price) price from(
				select users.user_id,purchase_option.god_num,purchase_option.ord_num,item_option.opt_price,purchase_option.opt_content
				from purchases
				full outer join goods
				on (purchases.god_num = goods.god_num)
				full outer join orders
				on (orders.ord_num = purchases.ord_num)
				full outer join point_policies
				on (pnp_num = 1)
				full outer join users
				on (orders.user_id = users.user_id)
				full outer join purchase_option
				on (orders.ord_num = purchase_option.ord_num)
				join item_option
				on (purchase_option.opt_name = item_option.opt_name and purchase_option.opt_content = item_option.opt_content)
				group by users.user_id,purchase_option.god_num,item_option.opt_price,purchase_option.ord_num,purchase_option.opt_content)
				group by user_id,ord_num,god_num) a
				full outer join
				(select users.user_id,purchases.god_num,purchases.ord_num,god_sellingprice,god_amount,usingpoint,user_joindate,user_name,user_level,count(distinct loglog_date) as visitcnt,user_hp,user_mailagreement,freedeliverymp,basic_fee
				from users
				full outer join orders
				on (orders.user_id = users.user_id)
				full outer join purchases
				on (orders.ord_num = purchases.ord_num and orders.ord_type != '교환' and orders.ord_type != '환불' and orders.ord_type != '주문취소')
				full outer join goods
				on (purchases.god_num = goods.god_num)
				full outer join login_logs
				on (users.user_id = login_logs.user_id)
				join point_policies
				on (pnp_num = 1)
				join delivery_policies
				on (dvp_num = 1)
				group by users.user_id,user_name,user_level,user_hp,user_mailagreement,user_joindate,user_state,god_sellingprice,god_amount,purchases.god_num,purchases.ord_num,usingpoint,freedeliverymp,basic_fee,user_level
				having user_state = '가입') b
				on a.user_id = b.user_id and a.ord_num = b.ord_num and a.god_num = b.god_num))
				group by user_joindate,user_name,user_id,ord_num,user_hp,visitcnt,user_mailagreement,usingpoint,freedeliverymp,basic_fee,user_level
				having user_id is not null)
				group by user_joindate,user_name,user_id,user_hp,visitcnt,user_mailagreement,user_level
				order by user_joindate desc
		  		)x where rownum <= #{rowCnt}*#{currentPage}
		  	)where rnum > #{rowCnt}*(#{currentPage}-1)
			]]>
	</select>
	
	<select id = "getSearchUsers"  parameterType="page" resultMap = "userMap">
	 <![CDATA[
		  select * from(
		  	select rownum as rnum, x.* from(			
				select user_joindate,user_name,user_level,user_id,sum(totalprice) as purchase_amount,user_hp,visitcnt,user_mailagreement from(
				select user_joindate,user_name,user_id,ord_num,
				(case when sum(price)-usingpoint <  freedeliverymp then sum(price)-usingpoint+basic_fee
				else sum(price)-usingpoint
				end) as totalprice
				,user_hp,visitcnt,user_mailagreement,user_level from(
				select b.user_joindate,b.user_name,b.user_id,b.ord_num,b.god_num,b.god_amount*(b.god_sellingprice+nvl(a.price,'0')) as price,b.user_hp,visitcnt,user_mailagreement,b.usingpoint,freedeliverymp,basic_fee,b.user_level from(
				(select user_id,ord_num,god_num,sum(opt_price) price from(
				select users.user_id,purchase_option.god_num,purchase_option.ord_num,item_option.opt_price,purchase_option.opt_content
				from purchases
				full outer join goods
				on (purchases.god_num = goods.god_num)
				full outer join orders
				on (orders.ord_num = purchases.ord_num)
				full outer join point_policies
				on (pnp_num = 1)
				full outer join users
				on (orders.user_id = users.user_id)
				full outer join purchase_option
				on (orders.ord_num = purchase_option.ord_num)
				join item_option
				on (purchase_option.opt_name = item_option.opt_name and purchase_option.opt_content = item_option.opt_content)
				group by users.user_id,purchase_option.god_num,item_option.opt_price,purchase_option.ord_num,purchase_option.opt_content)
				group by user_id,ord_num,god_num) a
				full outer join
				(select users.user_id,purchases.god_num,purchases.ord_num,god_sellingprice,god_amount,usingpoint,user_joindate,user_name,user_level,count(distinct loglog_date) as visitcnt,user_hp,user_mailagreement,freedeliverymp,basic_fee
				from users
				full outer join orders
				on (orders.user_id = users.user_id)
				full outer join purchases
				on (orders.ord_num = purchases.ord_num and orders.ord_type != '교환' and orders.ord_type != '환불' and orders.ord_type != '주문취소')
				full outer join goods
				on (purchases.god_num = goods.god_num)
				full outer join login_logs
				on (users.user_id = login_logs.user_id)
				join point_policies
				on (pnp_num = 1)
				join delivery_policies
				on (dvp_num = 1)
				group by users.user_id,user_name,user_level,user_hp,user_mailagreement,user_joindate,user_state,god_sellingprice,god_amount,purchases.god_num,purchases.ord_num,usingpoint,freedeliverymp,basic_fee,user_level
				having user_state = '가입') b
				on a.user_id = b.user_id and a.ord_num = b.ord_num and a.god_num = b.god_num))
				group by user_joindate,user_name,user_id,ord_num,user_hp,visitcnt,user_mailagreement,usingpoint,freedeliverymp,basic_fee,user_level
				having user_id is not null)
				group by user_joindate,user_name,user_id,user_hp,visitcnt,user_mailagreement,user_level
				having
				]]>
				<if test = "SearchBar == 1" >
				(user_name like '%' || #{title} || '%')
				</if>
				<if test = "sdate !='' " >
				<![CDATA[
					and user_joindate > to_date(#{sdate},'YYYY-MM-DD')
					and user_joindate < to_date(#{edate},'YYYY-MM-DD')
					]]>
				</if>
				<if test = "userLevel != 0">
				and user_level = #{userLevel}
				</if>
				<if test = "minPrice != ''">
				<![CDATA[
				and sum(totalprice) > #{minPrice}
				]]>
				</if>
				<if test = "maxPrice != ''">
				<![CDATA[
				and sum(totalprice) < #{maxPrice}
				]]>
				</if>
				<if test = "minSaved != ''">
				<![CDATA[
				and user_hp > ${minSaved}
				]]>
				</if>
				<if test = "maxSaved != ''">
				<![CDATA[
				and user_hp < ${maxSaved}
				]]>
				</if>
				<if test = "email != ''">
				and user_mailagreement = #{email}
				</if>
				order by user_joindate desc
				<![CDATA[
		  		)x where rownum <= #{rowCnt}*#{currentPage}
		  	)where rnum > #{rowCnt}*(#{currentPage}-1)
		  	]]>
	</select>
	
	<select id = "getUser" parameterType = "string" resultMap = "userMap">
		<![CDATA[
		select user_joindate,user_name,user_level,user_id,sum(totalprice) as purchase_amount,user_hp,visitcnt,user_mailagreement,
        	user_email,user_phone,user_postcode,user_street,user_detailarea,user_latestdate from(
				select user_joindate,user_name,user_id,ord_num,
				(case when sum(price)-usingpoint <  freedeliverymp then sum(price)-usingpoint+basic_fee
				else sum(price)-usingpoint
				end) as totalprice
				,user_hp,visitcnt,user_mailagreement,user_level,
	        	user_email,user_phone,user_postcode,user_street,user_detailarea,user_latestdate from(
				select b.user_joindate,b.user_name,b.user_id,b.ord_num,b.god_num,b.god_amount*(b.god_sellingprice+nvl(a.price,'0')) as price,b.user_hp,visitcnt,user_mailagreement,b.usingpoint,freedeliverymp,basic_fee,b.user_level,
	        	user_email,user_phone,user_postcode,user_street,user_detailarea,user_latestdate from(
				(select user_id,ord_num,god_num,sum(opt_price) price from(
				select users.user_id,purchase_option.god_num,purchase_option.ord_num,item_option.opt_price,purchase_option.opt_content
				from purchases
				full outer join goods
				on (purchases.god_num = goods.god_num)
				full outer join orders
				on (orders.ord_num = purchases.ord_num)
				full outer join point_policies
				on (pnp_num = 1)
				full outer join users
				on (orders.user_id = users.user_id)
				full outer join purchase_option
				on (orders.ord_num = purchase_option.ord_num)
				join item_option
				on (purchase_option.opt_name = item_option.opt_name and purchase_option.opt_content = item_option.opt_content)
				group by users.user_id,purchase_option.god_num,item_option.opt_price,purchase_option.ord_num,purchase_option.opt_content)
				group by user_id,ord_num,god_num) a
				full outer join
				(select users.user_id,purchases.god_num,purchases.ord_num,god_sellingprice,god_amount,usingpoint,user_joindate,user_name,user_level,count(distinct loglog_date) as visitcnt,user_hp,user_mailagreement,freedeliverymp,basic_fee,
	       		user_email,user_phone,user_postcode,user_street,user_detailarea,user_latestdate
				from users
				full outer join orders
				on (orders.user_id = users.user_id)
				full outer join purchases
				on (orders.ord_num = purchases.ord_num and orders.ord_type != '교환' and orders.ord_type != '환불' and orders.ord_type != '주문취소')
				full outer join goods
				on (purchases.god_num = goods.god_num)
				full outer join login_logs
				on (users.user_id = login_logs.user_id)
				join point_policies
				on (pnp_num = 1)
				join delivery_policies
				on (dvp_num = 1)
				group by users.user_id,user_name,user_level,user_hp,user_mailagreement,user_joindate,user_state,god_sellingprice,god_amount,purchases.god_num,purchases.ord_num,usingpoint,freedeliverymp,basic_fee,user_level,
	       	 	user_email,user_phone,user_postcode,user_street,user_detailarea,user_latestdate
				having user_state = '가입') b
				on a.user_id = b.user_id and a.ord_num = b.ord_num and a.god_num = b.god_num))
				group by user_joindate,user_name,user_id,ord_num,user_hp,visitcnt,user_mailagreement,usingpoint,freedeliverymp,basic_fee,user_level,
	        	user_email,user_phone,user_postcode,user_street,user_detailarea,user_latestdate
				having user_id is not null)
				group by user_joindate,user_name,user_id,user_hp,visitcnt,user_mailagreement,user_level,user_email,user_phone,user_postcode,user_street,user_detailarea,user_latestdate
				having user_id = #{userId}
			]]>
	</select>
	
	<select id = "getLoglog" parameterType = "string" resultType = "loglog">
		select loglog_date loglogDate
		from login_logs
		where user_id = #{userId}
	</select>
	
	<select id = "getPurl" parameterType = "string" resultType = "purl">
	<![CDATA[
				select ord_num,ord_date ordDate,
				(case when sum(price)-usingpoint <  freedeliverymp then sum(price)-usingpoint+basic_fee
				else sum(price)-usingpoint
				end) as totalprice
				,listagg(god_name,',') within group(order by god_name) godName  from(
				select b.ord_date,b.user_name,b.user_id,b.ord_num,b.god_num,b.god_amount*(b.god_sellingprice+nvl(a.price,'0')) as price,b.user_hp,visitcnt,user_mailagreement,b.usingpoint,freedeliverymp,basic_fee,b.user_level,b.god_name,
        user_email,user_phone,user_postcode,user_street,user_detailarea,user_latestdate from(
				(select user_id,ord_num,god_num,sum(opt_price) price from(
				select users.user_id,purchase_option.god_num,purchase_option.ord_num,item_option.opt_price,purchase_option.opt_content
				from purchases
				full outer join goods
				on (purchases.god_num = goods.god_num)
				full outer join orders
				on (orders.ord_num = purchases.ord_num)
				full outer join point_policies
				on (pnp_num = 1)
				full outer join users
				on (orders.user_id = users.user_id)
				full outer join purchase_option
				on (orders.ord_num = purchase_option.ord_num)
				join item_option
				on (purchase_option.opt_name = item_option.opt_name and purchase_option.opt_content = item_option.opt_content)
				group by users.user_id,purchase_option.god_num,item_option.opt_price,purchase_option.ord_num,purchase_option.opt_content)
				group by user_id,ord_num,god_num) a
				full outer join
				(select users.user_id,goods.god_name,purchases.god_num,purchases.ord_num,god_sellingprice,god_amount,usingpoint,orders.ord_date,user_name,user_level,count(distinct loglog_date) as visitcnt,user_hp,user_mailagreement,freedeliverymp,basic_fee,
        user_email,user_phone,user_postcode,user_street,user_detailarea,user_latestdate
				from users
				full outer join orders
				on (orders.user_id = users.user_id)
				full outer join purchases
				on (orders.ord_num = purchases.ord_num and orders.ord_type != '교환' and orders.ord_type != '환불' and orders.ord_type != '주문취소')
				full outer join goods
				on (purchases.god_num = goods.god_num)
				full outer join login_logs
				on (users.user_id = login_logs.user_id)
				join point_policies
				on (pnp_num = 1)
				join delivery_policies
				on (dvp_num = 1)
				group by users.user_id,user_name,user_level,user_hp,user_mailagreement,orders.ord_date,user_state,god_sellingprice,god_amount,purchases.god_num,purchases.ord_num,usingpoint,freedeliverymp,basic_fee,user_level,
        user_email,user_phone,user_postcode,user_street,user_detailarea,user_latestdate,goods.god_name
				having user_state = '가입') b
				on a.user_id = b.user_id and a.ord_num = b.ord_num and a.god_num = b.god_num))
				group by ord_date,user_name,user_id,ord_num,user_hp,visitcnt,user_mailagreement,usingpoint,freedeliverymp,basic_fee,user_level,
        user_email,user_phone,user_postcode,user_street,user_detailarea,user_latestdate
				having user_id is not null
				and ord_num is not null
        		and user_id = #{userId}
        		]]>
	</select>
	 
	<update id = "userStateChange" parameterType = "map">
		update users
		set user_state = '탈퇴'
		where user_id in
		<foreach item = "ls" collection = "list" index = "index" open="(" separator="," close=")">
			#{ls}
		</foreach> 
	</update>
	
	<resultMap id = "userMap" type = "user">
		<id property = "userId" column = "user_id"/>
		<result property = "userName" column = "user_name" />
		<result property = "userEmail" column = "user_email" />
		<result property = "userPhone" column = "user_phone" />
		<result property = "userPostcode" column = "user_postcode" />
		<result property = "userStreet" column = "user_street" />
		<result property = "userDetailArea" column = "user_detailarea" />
		<result property = "userLevel" column = "user_level" />
		<result property = "userHp" column = "user_hp" />
		<result property = "userJoinDate" column = "user_joindate"/>
		<result property = "userMailAgreement" column = "user_mailagreement" />
		<result property = "userVisitCnt" column = "visitcnt" />
		<result property = "userLatestDate" column = "user_latestdate" />
		<result property = "purchaseAmount" column = "purchase_amount" />
	</resultMap>
</mapper>